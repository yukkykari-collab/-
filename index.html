<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>PDF Digital Signage v2</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&family=Playfair+Display:wght@400;500&family=IBM+Plex+Mono:wght@300;400&display=swap');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME SYSTEM â€” 3 themes via data-theme attribute
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Theme 1: Dark (default) */
:root, [data-theme="dark"] {
  --bg: #0a0c10;
  --surface: #12151c;
  --surface2: #1a1e28;
  --surface3: #232838;
  --border: rgba(255,255,255,0.07);
  --border2: rgba(255,255,255,0.12);
  --accent: #4f8ef7;
  --accent2: #7eb8f5;
  --accent-glow: rgba(79,142,247,0.2);
  --text: #e8ecf4;
  --text-dim: #6b7490;
  --text-muted: rgba(232,236,244,0.3);
  --shadow: 0 20px 80px rgba(0,0,0,0.6);
  --topbar-blur: blur(0px);
  --font-ui: 'DM Sans', 'Noto Sans JP', sans-serif;
  --font-brand: 'DM Sans', sans-serif;
  --brand-letter-spacing: 0.12em;
  --thumb-border-radius: 5px;
  --btn-radius: 6px;
  --green: #7edd8a;
  --green-bg: #2a5c34;
  --red: #ff6b6b;
  --orange: #f0a855;
}

/* Theme 2: Light/Corporate */
[data-theme="light"] {
  --bg: #f4f5f7;
  --surface: #ffffff;
  --surface2: #f0f1f4;
  --surface3: #e6e8ed;
  --border: rgba(0,0,0,0.08);
  --border2: rgba(0,0,0,0.14);
  --accent: #1a56db;
  --accent2: #3b82f6;
  --accent-glow: rgba(26,86,219,0.1);
  --text: #1a1e2e;
  --text-dim: #6b7280;
  --text-muted: rgba(26,30,46,0.3);
  --shadow: 0 8px 40px rgba(0,0,0,0.12);
  --font-ui: 'DM Sans', 'Noto Sans JP', sans-serif;
  --font-brand: 'DM Sans', sans-serif;
  --brand-letter-spacing: 0.1em;
  --thumb-border-radius: 4px;
  --btn-radius: 5px;
  --green: #16a34a;
  --green-bg: #dcfce7;
  --red: #dc2626;
  --orange: #d97706;
}

/* Theme 3: Warm/Elegant */
[data-theme="warm"] {
  --bg: #1a1510;
  --surface: #221c14;
  --surface2: #2e2518;
  --surface3: #3a2f1e;
  --border: rgba(255,220,150,0.08);
  --border2: rgba(255,220,150,0.15);
  --accent: #d4a853;
  --accent2: #e8c97a;
  --accent-glow: rgba(212,168,83,0.15);
  --text: #f2e8d8;
  --text-dim: #8a7a62;
  --text-muted: rgba(242,232,216,0.25);
  --shadow: 0 20px 80px rgba(0,0,0,0.7);
  --font-ui: 'Noto Sans JP', sans-serif;
  --font-brand: 'Playfair Display', serif;
  --brand-letter-spacing: 0.06em;
  --thumb-border-radius: 3px;
  --btn-radius: 4px;
  --green: #86efac;
  --green-bg: #14532d;
  --red: #fca5a5;
  --orange: #fcd34d;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--font-ui);
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  user-select: none;
  transition: background 0.3s, color 0.3s;
}

/* When thumbs visible, push content up */
body.thumbs-visible { padding-bottom: 112px; }

/* â”€â”€ Scrollbars â”€â”€ */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 2px; }

/* â”€â”€ Top bar â”€â”€ */
#topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: env(safe-area-inset-top, 0px) 20px 0;
  height: calc(50px + env(safe-area-inset-top, 0px));
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  z-index: 20;
  gap: 10px;
}
.brand {
  font-family: var(--font-brand);
  font-size: 13px;
  font-weight: 500;
  letter-spacing: var(--brand-letter-spacing);
  text-transform: uppercase;
  color: var(--text-dim);
  white-space: nowrap;
  flex-shrink: 0;
}
.topbar-left { display: flex; align-items: center; gap: 14px; }
.topbar-right { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }

/* Schedule status indicator */
#schedule-status {
  font-size: 11px;
  color: var(--text-dim);
  padding: 3px 8px;
  border: 1px solid var(--border);
  border-radius: 4px;
  white-space: nowrap;
  display: none;
}
#schedule-status.active { color: var(--green); border-color: var(--green); background: rgba(126,221,138,0.06); }
#schedule-status.waiting { color: var(--orange); border-color: var(--orange); background: rgba(240,168,85,0.06); }
#schedule-status.show { display: block; }

/* â”€â”€ Buttons â”€â”€ */
.ctrl-btn {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: var(--btn-radius);
  padding: 5px 12px;
  font-size: 11.5px;
  font-family: inherit;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s, color 0.15s;
  white-space: nowrap;
  flex-shrink: 0;
}
.ctrl-btn:hover { background: var(--surface3); border-color: var(--border2); }
.ctrl-btn:disabled { opacity: 0.35; cursor: not-allowed; }
.ctrl-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }
.ctrl-btn.danger { border-color: rgba(255,80,80,0.4); color: var(--red); }
.ctrl-btn.danger:hover { background: rgba(255,80,80,0.08); }
.ctrl-btn.demo { border-color: rgba(120,220,120,0.4); color: var(--green); }
.ctrl-btn.demo:hover { background: rgba(120,220,120,0.06); }
.ctrl-btn.demo.active { background: var(--green-bg); border-color: var(--green); color: var(--green); }

#slide-count-label { font-size: 11px; color: var(--text-dim); white-space: nowrap; }

/* â”€â”€ Viewer â”€â”€ */
#viewer {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
  background: var(--bg);
  transition: background 0.3s;
}

#main-canvas {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  border-radius: 3px;
  box-shadow: var(--shadow);
  transition: opacity 0.35s ease;
  display: none;
}

/* Fullscreen â€” hide topbar only */
body.fullscreen #topbar { display: none !important; }
body.fullscreen #viewer { flex: 1; }
/* Hide header text, thumb labels, and slide count in fullscreen */
body.fullscreen #thumb-strip-header { display: none !important; }
body.fullscreen .thumb-label { display: none !important; }
body.fullscreen #thumb-strip-count { display: none !important; }

/* Progress bar */
#progress-bar-wrap {
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: rgba(255,255,255,0.04);
  z-index: 5;
}
#progress-bar {
  height: 100%;
  background: var(--accent);
  width: 0%;
}

/* Slide info */
#slide-info {
  position: absolute;
  bottom: 14px; right: 16px;
  font-size: 11px;
  color: var(--text-muted);
  letter-spacing: 0.06em;
  font-weight: 300;
  z-index: 5;
}

/* Demo badge */
#demo-badge {
  display: none;
  position: absolute;
  top: 12px; left: 14px;
  background: rgba(126,221,138,0.1);
  border: 1px solid rgba(126,221,138,0.3);
  color: var(--green);
  font-size: 10px;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  font-weight: 500;
  padding: 3px 8px;
  border-radius: 4px;
  z-index: 6;
}
#demo-badge.show { display: block; }


/* Outside-schedule overlay */
#schedule-overlay {
  position: absolute;
  inset: 0;
  background: #000;
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 12px;
  z-index: 8;
}
#schedule-overlay.show { display: flex; }
#schedule-overlay p { color: rgba(255,255,255,0.2); font-size: 13px; letter-spacing: 0.08em; font-weight: 300; }
#schedule-clock {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 42px;
  font-weight: 300;
  color: rgba(255,255,255,0.12);
  letter-spacing: 0.04em;
}

/* Empty state */
#empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 14px;
  color: var(--text-dim);
}
#empty-state svg { opacity: 0.25; }
#empty-state p { font-size: 13px; font-weight: 300; letter-spacing: 0.04em; }

/* Pause overlay */
#pause-overlay {
  position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  background: rgba(0,0,0,0.22);
  opacity: 0; pointer-events: none;
  transition: opacity 0.2s;
  z-index: 7;
}
#pause-overlay.show { opacity: 1; }
#pause-icon {
  width: 60px; height: 60px;
  background: rgba(255,255,255,0.1);
  backdrop-filter: blur(8px);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
}


/* â”€â”€ Thumbnail strip â”€â”€ */
#thumb-strip-wrap {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  z-index: 30;
  background: var(--surface);
  border-top: 1px solid var(--border);
  padding: 8px 14px calc(10px + env(safe-area-inset-bottom, 0px));
  transition: background 0.3s;
}
#thumb-strip-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 8px;
}
#thumb-strip-header span {
  font-size: 10px; text-transform: uppercase;
  letter-spacing: 0.1em; color: var(--text-dim); font-weight: 500;
}
#thumb-strip {
  display: flex;
  gap: 6px;
  overflow: hidden;
  padding-bottom: 2px;
  align-items: flex-end;
  width: 100%;
}

.thumb-item {
  flex: 1 1 0;
  min-width: 0;
  max-width: 120px;
  display: flex; flex-direction: column; align-items: center;
  gap: 4px; cursor: grab; position: relative;
  transition: transform 0.15s;
}
.thumb-item:active { cursor: grabbing; }
.thumb-item.dragging { opacity: 0.4; transform: scale(0.96); }
.thumb-item.drag-over-left::before,
.thumb-item.drag-over-right::after {
  content: '';
  position: absolute;
  top: 0; bottom: 20px; width: 2px;
  background: var(--accent);
  border-radius: 1px;
}
.thumb-item.drag-over-left::before { left: -5px; }
.thumb-item.drag-over-right::after { right: -5px; }

.thumb-canvas-wrap {
  width: 100%;
  border-radius: var(--thumb-border-radius);
  overflow: hidden;
  border: 1.5px solid transparent;
  transition: border-color 0.2s, box-shadow 0.2s;
  background: var(--bg);
  position: relative;
}
.thumb-canvas-wrap canvas { width: 100%; height: auto; display: block; }
.thumb-item.active .thumb-canvas-wrap {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}
.thumb-label { font-size: 10px; color: var(--text-dim); letter-spacing: 0.03em; }
.thumb-item.active .thumb-label { color: var(--accent2); }
.thumb-dot {
  position: absolute; top: -4px; right: -4px;
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--accent); display: none;
  box-shadow: 0 0 5px var(--accent);
}
.thumb-item.active .thumb-dot { display: block; }

/* Delete button on thumbnail */
.thumb-delete {
  position: absolute;
  top: -6px; left: -6px;
  width: 18px; height: 18px;
  border-radius: 50%;
  background: var(--red);
  color: #fff;
  font-size: 11px;
  line-height: 18px;
  text-align: center;
  cursor: pointer;
  display: none;
  z-index: 10;
  box-shadow: 0 1px 4px rgba(0,0,0,0.4);
  transition: transform 0.12s, background 0.12s;
  user-select: none;
}
.thumb-delete:hover { transform: scale(1.2); background: #ff3333; }
.thumb-item:hover .thumb-delete { display: block; }

/* Per-slide duration badge */
.thumb-duration {
  position: absolute;
  bottom: 4px; right: 4px;
  background: rgba(0,0,0,0.6);
  color: rgba(255,255,255,0.7);
  font-size: 9px;
  padding: 1px 4px;
  border-radius: 3px;
  font-family: 'IBM Plex Mono', monospace;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS (shared base)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(6px);
  z-index: 100;
  display: none;
  align-items: center; justify-content: center;
}
.modal-overlay.show { display: flex; }
.modal-panel {
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 14px;
  padding: 26px 28px;
  width: 460px; max-width: 94vw;
  box-shadow: 0 30px 80px rgba(0,0,0,0.5);
  max-height: 90vh;
  overflow-y: auto;
}
.modal-panel h2 {
  font-size: 15px; font-weight: 500;
  margin-bottom: 20px; letter-spacing: 0.02em;
}
.modal-panel h3 {
  font-size: 11px; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 0.1em;
  margin: 20px 0 10px; font-weight: 500;
}
.setting-row { margin-bottom: 14px; }
.setting-row label {
  display: block; font-size: 11px; color: var(--text-dim);
  margin-bottom: 6px; text-transform: uppercase;
  letter-spacing: 0.08em; font-weight: 500;
}
.setting-row input[type=number],
.setting-row input[type=text],
.setting-row input[type=password],
.setting-row input[type=time],
.setting-row select {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--btn-radius);
  color: var(--text);
  font-size: 13px;
  font-family: inherit;
  padding: 7px 10px;
  outline: none;
  transition: border-color 0.15s;
  appearance: none;
}
.setting-row input:focus, .setting-row select:focus { border-color: var(--accent); }
.setting-row input[type=range] {
  width: 100%; padding: 5px 2px;
  accent-color: var(--accent); background: transparent; border: none;
}
.range-display { font-size: 12px; color: var(--accent2); text-align: right; margin-top: 3px; }
.modal-actions { display: flex; gap: 8px; margin-top: 22px; justify-content: flex-end; }
.row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.toggle-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
}
.toggle-row:last-child { border-bottom: none; }
.toggle-row span { font-size: 13px; color: var(--text); }
.toggle-switch {
  width: 36px; height: 20px;
  background: var(--surface3); border-radius: 10px;
  position: relative; cursor: pointer;
  transition: background 0.2s;
  flex-shrink: 0;
}
.toggle-switch.on { background: var(--accent); }
.toggle-switch::after {
  content: '';
  position: absolute;
  width: 14px; height: 14px;
  border-radius: 50%;
  background: #fff;
  top: 3px; left: 3px;
  transition: left 0.2s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
.toggle-switch.on::after { left: 19px; }

/* â”€â”€ Password lock modal â”€â”€ */
#lock-screen {
  position: fixed; inset: 0;
  background: var(--bg);
  z-index: 500;
  display: none;
  align-items: center; justify-content: center;
  flex-direction: column; gap: 20px;
}
#lock-screen.show { display: flex; }
#lock-screen h2 {
  font-size: 18px; font-weight: 300;
  letter-spacing: 0.04em; color: var(--text);
}
#lock-screen p { font-size: 12px; color: var(--text-dim); }
#lock-screen input {
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: var(--btn-radius);
  color: var(--text); font-size: 14px;
  font-family: inherit; padding: 10px 14px;
  outline: none; width: 260px;
  text-align: center; letter-spacing: 0.1em;
}
#lock-screen input:focus { border-color: var(--accent); }
#lock-error { font-size: 12px; color: var(--red); display: none; }
#lock-screen .lock-icon { font-size: 32px; opacity: 0.4; }

/* â”€â”€ Slide duration editor (in modal) â”€â”€ */
#slide-duration-list { display: flex; flex-direction: column; gap: 6px; }
.sdl-item {
  display: grid; grid-template-columns: 1fr auto auto;
  gap: 8px; align-items: center;
  padding: 7px 10px;
  background: var(--surface2);
  border-radius: var(--btn-radius);
  border: 1px solid var(--border);
}
.sdl-name { font-size: 12px; color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.sdl-input {
  width: 64px;
  background: var(--surface3);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--text); font-size: 12px;
  font-family: 'IBM Plex Mono', monospace;
  padding: 3px 6px; text-align: right; outline: none;
}
.sdl-input:focus { border-color: var(--accent); }
.sdl-unit { font-size: 11px; color: var(--text-dim); }

/* â”€â”€ Loading â”€â”€ */
#loading-overlay {
  position: fixed; inset: 0;
  background: rgba(10,12,16,0.88);
  backdrop-filter: blur(4px);
  z-index: 300;
  display: none; align-items: center;
  justify-content: center; flex-direction: column; gap: 14px;
}
#loading-overlay.show { display: flex; }
#loading-overlay p { font-size: 12px; color: var(--text-dim); letter-spacing: 0.06em; }
.spinner {
  width: 34px; height: 34px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€ Upload zone â”€â”€ */
#upload-zone {
  position: fixed; inset: 0;
  background: rgba(10,12,16,0.94);
  backdrop-filter: blur(8px);
  z-index: 200;
  display: flex; align-items: center; justify-content: center;
}
#upload-zone.hidden { display: none; }
#upload-inner {
  border: 1.5px dashed rgba(79,142,247,0.35);
  border-radius: 18px; padding: 52px 72px;
  text-align: center; cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
}
#upload-inner:hover, #upload-inner.drag-over {
  border-color: var(--accent); background: rgba(79,142,247,0.04);
}
#upload-inner h2 { font-size: 20px; font-weight: 300; margin-bottom: 6px; }
#upload-inner p { font-size: 12px; color: var(--text-dim); margin-bottom: 20px; }
#file-input { display: none; }

/* Theme switcher dots */
#theme-switcher { display: flex; gap: 6px; align-items: center; }
.theme-dot {
  width: 14px; height: 14px; border-radius: 50%; cursor: pointer;
  border: 1.5px solid transparent;
  transition: transform 0.15s, border-color 0.15s;
  flex-shrink: 0;
}
.theme-dot:hover { transform: scale(1.2); }
.theme-dot.active { border-color: var(--accent); }
.theme-dot[data-t="dark"] { background: #12151c; box-shadow: 0 0 0 1px rgba(255,255,255,0.15); }
.theme-dot[data-t="light"] { background: #1a56db; }
.theme-dot[data-t="warm"] { background: #d4a853; }

/* Orientation toggle */
#viewer.portrait #main-canvas {
  max-height: 100%;
  max-width: min(56vh, 100%);
}

/* â”€â”€ Vertical layout mode (portrait signage) â”€â”€ */
body.portrait-mode {
  /* flip the strip to right side */
}
body.portrait-mode #thumb-strip-wrap {
  border-top: none; border-left: 1px solid var(--border);
  width: 100px; padding: 10px 8px;
  overflow-y: auto; overflow-x: hidden;
}
body.portrait-mode #thumb-strip { flex-direction: column; overflow-x: visible; overflow-y: auto; }
body.portrait-mode #main-layout { flex-direction: row; }
body.portrait-mode .thumb-canvas-wrap { width: 76px; }
body.portrait-mode .thumb-canvas-wrap canvas { width: 100%; height: auto; }

#main-layout { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
</style>
</head>
<body data-theme="dark">

<!-- Upload Zone -->
<div id="upload-zone">
  <div id="upload-inner" onclick="document.getElementById('file-input').click()">
    <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="rgba(79,142,247,0.5)" stroke-width="1.2" style="margin:0 auto 14px">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
      <polyline points="14 2 14 8 20 8"/>
      <line x1="12" y1="18" x2="12" y2="12"/>
      <line x1="9" y1="15" x2="15" y2="15"/>
    </svg>
    <h2>PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€</h2>
    <p>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆè¤‡æ•°å¯ï¼‰</p>
    <button class="ctrl-btn active" style="pointer-events:none">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
  </div>
  <input type="file" id="file-input" multiple accept=".pdf">
</div>

<!-- Top bar -->
<div id="topbar">
  <div class="topbar-left">
    <div class="brand">Signage</div>
    <span id="slide-count-label">â€”</span>
    <span id="schedule-status"></span>
  </div>
  <div class="topbar-right">
    <!-- Theme switcher -->
    <div id="theme-switcher" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">
      <div class="theme-dot active" data-t="dark" title="ãƒ€ãƒ¼ã‚¯"></div>
      <div class="theme-dot" data-t="light" title="ãƒ©ã‚¤ãƒˆ"></div>
      <div class="theme-dot" data-t="warm" title="ã‚¦ã‚©ãƒ¼ãƒ "></div>
    </div>
    <button class="ctrl-btn" id="btn-add">+ è¿½åŠ </button>
    <button class="ctrl-btn demo" id="btn-demo">ãƒ‡ãƒ¢</button>
    <button class="ctrl-btn" id="btn-schedule" title="ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š">â° ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</button>
    <button class="ctrl-btn" id="btn-durations" title="ã‚¹ãƒ©ã‚¤ãƒ‰ã”ã¨ã®è¡¨ç¤ºæ™‚é–“">â± æ™‚é–“è¨­å®š</button>
    <button class="ctrl-btn" id="btn-settings">è¨­å®š</button>
    <button class="ctrl-btn" id="btn-fullscreen">â›¶ å…¨ç”»é¢</button>
    <button class="ctrl-btn" id="btn-play" disabled>â–¶ å†ç”Ÿ</button>
    <button class="ctrl-btn danger" id="btn-clear" style="display:none">ã‚¯ãƒªã‚¢</button>
  </div>
</div>

<!-- Main layout -->
<div id="main-layout">
  <!-- Viewer -->
  <div id="viewer">
    <div id="progress-bar-wrap"><div id="progress-bar"></div></div>
    <div id="demo-badge">Demo</div>
    <div id="empty-state">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
        <rect x="3" y="3" width="18" height="18" rx="2"/>
        <line x1="3" y1="9" x2="21" y2="9"/>
        <line x1="9" y1="21" x2="9" y2="9"/>
      </svg>
      <p>PDFã‚’èª­ã¿è¾¼ã‚€ã¨ã‚¹ãƒ©ã‚¤ãƒ‰ã‚·ãƒ§ãƒ¼ãŒé–‹å§‹ã•ã‚Œã¾ã™</p>
    </div>
    <canvas id="main-canvas"></canvas>
    <div id="slide-info"></div>
    <div id="pause-overlay">
      <div id="pause-icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
          <rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>
        </svg>
      </div>
    </div>
    <div id="schedule-overlay">
      <div id="schedule-clock">--:--:--</div>
      <p>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å¤–ã®æ™‚é–“å¸¯ã§ã™</p>
    </div>
  </div>
</div>

<!-- Thumbnail strip â€” always at bottom of viewport -->
<div id="thumb-strip-wrap" style="display:none">
  <div id="thumb-strip-header">
    <span>ã‚¹ãƒ©ã‚¤ãƒ‰ä¸€è¦§ â€” ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆ</span>
    <span id="thumb-strip-count" style="color:var(--accent2)"></span>
  </div>
  <div id="thumb-strip"></div>
</div>

<!-- Loading overlay -->
<div id="loading-overlay">
  <div class="spinner"></div>
  <p id="loading-text">èª­ã¿è¾¼ã¿ä¸­â€¦</p>
</div>

<!-- â”€â”€ Settings Modal â”€â”€ -->
<div class="modal-overlay" id="settings-overlay">
  <div class="modal-panel">
    <h2>è¡¨ç¤ºè¨­å®š</h2>
    <div class="setting-row">
      <label>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºæ™‚é–“ï¼ˆç§’ï¼‰</label>
      <input type="number" id="set-duration" value="5" min="1" max="300">
    </div>
    <div class="setting-row">
      <label>ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³é€Ÿåº¦</label>
      <input type="range" id="set-transition" min="100" max="1200" step="50" value="350">
      <div class="range-display" id="transition-display">350ms</div>
    </div>
    <h3>å†ç”Ÿã‚ªãƒ—ã‚·ãƒ§ãƒ³</h3>
    <div class="toggle-row">
      <span>ãƒ«ãƒ¼ãƒ—å†ç”Ÿ</span>
      <div class="toggle-switch on" id="toggle-loop"></div>
    </div>
    <div class="toggle-row">
      <span>ç¸¦å‘ãè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</span>
      <div class="toggle-switch" id="toggle-portrait"></div>
    </div>
    <div class="toggle-row">
      <span>ã‚µãƒ ãƒã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º</span>
      <div class="toggle-switch on" id="toggle-thumbs"></div>
    </div>
    <div class="modal-actions">
      <button class="ctrl-btn" id="btn-settings-close">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="ctrl-btn active" id="btn-settings-save">é©ç”¨</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Schedule Modal â”€â”€ -->
<div class="modal-overlay" id="schedule-overlay-modal">
  <div class="modal-panel">
    <h2>â° ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š</h2>
    <div class="toggle-row" style="margin-bottom:14px">
      <span>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹</span>
      <div class="toggle-switch" id="toggle-schedule"></div>
    </div>
    <div id="schedule-fields">
      <div class="row-2">
        <div class="setting-row">
          <label>é–‹å§‹æ™‚åˆ»</label>
          <input type="time" id="set-schedule-start" value="09:00">
        </div>
        <div class="setting-row">
          <label>çµ‚äº†æ™‚åˆ»</label>
          <input type="time" id="set-schedule-end" value="18:00">
        </div>
      </div>
      <div class="setting-row">
        <label>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å¤–ã®å‹•ä½œ</label>
        <select id="set-schedule-action">
          <option value="black">é»’ç”»é¢ã§å¾…æ©Ÿ</option>
          <option value="stop">å†ç”Ÿã‚’åœæ­¢ï¼ˆæ™‚è¨ˆè¡¨ç¤ºï¼‰</option>
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="ctrl-btn" id="btn-schedule-close">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="ctrl-btn active" id="btn-schedule-save">é©ç”¨</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Per-Slide Duration Modal â”€â”€ -->
<div class="modal-overlay" id="durations-overlay">
  <div class="modal-panel">
    <h2>â± ã‚¹ãƒ©ã‚¤ãƒ‰ã”ã¨ã®è¡¨ç¤ºæ™‚é–“</h2>
    <p style="font-size:12px;color:var(--text-dim);margin-bottom:14px">ç©ºæ¬„ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ™‚é–“ï¼ˆè¨­å®šã§å¤‰æ›´å¯ï¼‰ãŒä½¿ç”¨ã•ã‚Œã¾ã™</p>
    <div id="slide-duration-list"></div>
    <div class="modal-actions">
      <button class="ctrl-btn" id="btn-durations-close">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="ctrl-btn active" id="btn-durations-save">é©ç”¨</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Password Lock Modal (settings) â”€â”€ -->
<div class="modal-overlay" id="lock-settings-overlay">
  <div class="modal-panel">
    <h2>ğŸ”’ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ­ãƒƒã‚¯</h2>
    <div class="toggle-row" style="margin-bottom:14px">
      <span>ãƒ­ãƒƒã‚¯æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹</span>
      <div class="toggle-switch" id="toggle-lock"></div>
    </div>
    <div id="lock-fields">
      <div class="setting-row">
        <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="set-lock-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
      </div>
      <div class="setting-row">
        <label>ç¢ºèª</label>
        <input type="password" id="set-lock-confirm" placeholder="ã‚‚ã†ä¸€åº¦å…¥åŠ›">
      </div>
      <p id="lock-setup-error" style="font-size:12px;color:var(--red);display:none">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“</p>
    </div>
    <div class="modal-actions">
      <button class="ctrl-btn" id="btn-lock-settings-close">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="ctrl-btn active" id="btn-lock-settings-save">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Lock Screen â”€â”€ -->
<div id="lock-screen">
  <div class="lock-icon">ğŸ”’</div>
  <h2>è¨­å®šãŒãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™</h2>
  <p>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
  <input type="password" id="lock-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="off">
  <p id="lock-error">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</p>
  <button class="ctrl-btn active" id="btn-lock-enter" style="width:260px;padding:10px">è§£é™¤</button>
</div>

<script>
// â”€â”€ Suppress known PDF.js noise warnings â”€â”€
(function() {
  const _warn = console.warn.bind(console);
  const _error = console.error.bind(console);
  const suppress = [
    'fake worker', 'CMap', 'translateFont', 'loadFont',
    'Error during font loading', 'UnknownErrorException',
  ];
  const shouldSuppress = msg => suppress.some(s => String(msg).includes(s));
  console.warn  = (...a) => { if (!shouldSuppress(a[0])) _warn(...a); };
  console.error = (...a) => { if (!shouldSuppress(a[0])) _error(...a); };
})();

pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
const PDFJS_OPTS = {
  cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/',
  cMapPacked: true,
  standardFontDataUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/standard_fonts/',
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const state = {
  slides: [],         // {name, pages[], customDuration}
  flatSlides: [],     // {slideIdx, pageIdx, label, shortLabel}
  current: 0,
  playing: false,
  paused: false,
  timer: null,
  duration: 5000,     // default ms
  transition: 350,
  loop: true,
  portraitMode: false,
  showThumbs: true,
  // Schedule
  scheduleEnabled: false,
  scheduleStart: '09:00',
  scheduleEnd: '18:00',
  scheduleAction: 'black',
  scheduleCheckTimer: null,
  // Lock
  lockEnabled: false,
  lockPassword: '',
  locked: false,
  pendingAction: null,
  // Theme
  theme: 'dark',
  // Demo
  isDemo: false,
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOM REFS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const uploadZone = document.getElementById('upload-zone');
const fileInput = document.getElementById('file-input');
const mainCanvas = document.getElementById('main-canvas');
const ctx = mainCanvas.getContext('2d');
const emptyState = document.getElementById('empty-state');
const thumbStrip = document.getElementById('thumb-strip');
const thumbStripWrap = document.getElementById('thumb-strip-wrap');
const progressBar = document.getElementById('progress-bar');
const slideInfo = document.getElementById('slide-info');
const pauseOverlay = document.getElementById('pause-overlay');
const slideCountLabel = document.getElementById('slide-count-label');
const thumbStripCount = document.getElementById('thumb-strip-count');
const btnPlay = document.getElementById('btn-play');
const btnAdd = document.getElementById('btn-add');
const btnClear = document.getElementById('btn-clear');
const btnDemo = document.getElementById('btn-demo');
const btnFullscreen = document.getElementById('btn-fullscreen');
const demoBadge = document.getElementById('demo-badge');
const scheduleStatus = document.getElementById('schedule-status');
const scheduleOverlay = document.getElementById('schedule-overlay');
const scheduleClock = document.getElementById('schedule-clock');
const loadingOverlay = document.getElementById('loading-overlay');
const loadingText = document.getElementById('loading-text');
const lockScreen = document.getElementById('lock-screen');
const lockInput = document.getElementById('lock-input');
const lockError = document.getElementById('lock-error');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERSIST (localStorage)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveSettings() {
  const s = {
    duration: state.duration,
    transition: state.transition,
    loop: state.loop,
    portraitMode: state.portraitMode,
    showThumbs: state.showThumbs,
    scheduleEnabled: state.scheduleEnabled,
    scheduleStart: state.scheduleStart,
    scheduleEnd: state.scheduleEnd,
    scheduleAction: state.scheduleAction,
    lockEnabled: state.lockEnabled,
    lockPassword: state.lockPassword,
    theme: state.theme,
    slideDurations: state.slides.map(s => s.customDuration || null),
  };
  try { localStorage.setItem('signage_settings', JSON.stringify(s)); } catch(e) {}
}

function loadSettings() {
  try {
    const raw = localStorage.getItem('signage_settings');
    if (!raw) return;
    const s = JSON.parse(raw);
    if (s.duration) state.duration = s.duration;
    if (s.transition) state.transition = s.transition;
    if (s.loop !== undefined) state.loop = s.loop;
    if (s.portraitMode !== undefined) state.portraitMode = s.portraitMode;
    if (s.showThumbs !== undefined) state.showThumbs = s.showThumbs;
    if (s.scheduleEnabled !== undefined) state.scheduleEnabled = s.scheduleEnabled;
    if (s.scheduleStart) state.scheduleStart = s.scheduleStart;
    if (s.scheduleEnd) state.scheduleEnd = s.scheduleEnd;
    if (s.scheduleAction) state.scheduleAction = s.scheduleAction;
    if (s.lockEnabled !== undefined) state.lockEnabled = s.lockEnabled;
    if (s.lockPassword) state.lockPassword = s.lockPassword;
    if (s.theme) { state.theme = s.theme; applyTheme(s.theme, false); }
    applyPortraitMode();
    applyCanvasTransition();
    startScheduleChecker();
  } catch(e) {}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function applyTheme(theme, save = true) {
  state.theme = theme;
  document.body.dataset.theme = theme;
  document.querySelectorAll('.theme-dot').forEach(d => {
    d.classList.toggle('active', d.dataset.t === theme);
  });
  if (save) saveSettings();
}
document.querySelectorAll('.theme-dot').forEach(d => {
  d.addEventListener('click', () => applyTheme(d.dataset.t));
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PORTRAIT MODE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function applyPortraitMode() {
  document.body.classList.toggle('portrait-mode', state.portraitMode);
  document.getElementById('viewer').classList.toggle('portrait', state.portraitMode);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FULLSCREEN
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
btnFullscreen.addEventListener('click', () => {
  if (!document.fullscreenElement) {
    document.body.requestFullscreen().catch(() => {
      // fallback: CSS-only fullscreen
      document.body.classList.add('fullscreen');
      btnFullscreen.textContent = 'â›¶ è§£é™¤';
    });
  } else {
    document.exitFullscreen();
  }
});
document.addEventListener('fullscreenchange', () => {
  const isFs = !!document.fullscreenElement;
  document.body.classList.toggle('fullscreen', isFs);
  btnFullscreen.textContent = isFs ? 'â›¶ è§£é™¤' : 'â›¶ å…¨ç”»é¢';
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && !document.fullscreenElement) {
    document.body.classList.remove('fullscreen');
    btnFullscreen.textContent = 'â›¶ å…¨ç”»é¢';
  }
});

// â”€â”€ DevTools detection: exit fullscreen if devtools opens â”€â”€
(function() {
  const threshold = 160;
  let devtoolsOpen = false;
  function check() {
    const widthDiff  = window.outerWidth  - window.innerWidth;
    const heightDiff = window.outerHeight - window.innerHeight;
    const opened = widthDiff > threshold || heightDiff > threshold;
    if (opened && !devtoolsOpen) {
      devtoolsOpen = true;
      if (document.fullscreenElement) {
        document.exitFullscreen();
      } else if (document.body.classList.contains('fullscreen')) {
        document.body.classList.remove('fullscreen');
        btnFullscreen.textContent = 'â›¶ å…¨ç”»é¢';
      }
    } else if (!opened) {
      devtoolsOpen = false;
    }
  }
  setInterval(check, 500);
  window.addEventListener('resize', check);
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCHEDULE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function isInSchedule() {
  if (!state.scheduleEnabled) return true;
  const now = new Date();
  const cur = now.getHours() * 60 + now.getMinutes();
  const [sh, sm] = state.scheduleStart.split(':').map(Number);
  const [eh, em] = state.scheduleEnd.split(':').map(Number);
  const start = sh * 60 + sm, end = eh * 60 + em;
  if (start <= end) return cur >= start && cur < end;
  return cur >= start || cur < end; // overnight
}

function updateScheduleUI() {
  const inSchedule = isInSchedule();
  const clockStr = new Date().toLocaleTimeString('ja-JP', { hour12: false });
  scheduleClock.textContent = clockStr;

  if (!state.scheduleEnabled) {
    scheduleStatus.className = 'show';
    scheduleStatus.textContent = '';
    scheduleStatus.className = '';
    scheduleOverlay.classList.remove('show');
    return;
  }

  scheduleStatus.classList.add('show');
  if (inSchedule) {
    scheduleStatus.className = 'show active';
    scheduleStatus.textContent = `â— ${state.scheduleStart}ã€œ${state.scheduleEnd} é…ä¿¡ä¸­`;
    scheduleOverlay.classList.remove('show');
    if (!state.playing && state.flatSlides.length) startPlayback();
  } else {
    scheduleStatus.className = 'show waiting';
    scheduleStatus.textContent = `â—Œ ${state.scheduleStart}ã€œ${state.scheduleEnd} å¾…æ©Ÿä¸­`;
    if (state.playing) stopPlayback();
    if (state.scheduleAction === 'black' || state.scheduleAction === 'stop') {
      scheduleOverlay.classList.add('show');
    }
  }
}

function startScheduleChecker() {
  clearInterval(state.scheduleCheckTimer);
  state.scheduleCheckTimer = setInterval(updateScheduleUI, 1000);
  updateScheduleUI();
}

/* â”€â”€ Schedule modal â”€â”€ */
const scheduleModal = document.getElementById('schedule-overlay-modal');
const toggleSchedule = document.getElementById('toggle-schedule');
const scheduleFields = document.getElementById('schedule-fields');

document.getElementById('btn-schedule').addEventListener('click', () => {
  if (!checkLock('schedule')) return;
  toggleSchedule.classList.toggle('on', state.scheduleEnabled);
  document.getElementById('set-schedule-start').value = state.scheduleStart;
  document.getElementById('set-schedule-end').value = state.scheduleEnd;
  document.getElementById('set-schedule-action').value = state.scheduleAction;
  scheduleFields.style.opacity = state.scheduleEnabled ? '1' : '0.4';
  scheduleModal.classList.add('show');
});
toggleSchedule.addEventListener('click', () => {
  toggleSchedule.classList.toggle('on');
  scheduleFields.style.opacity = toggleSchedule.classList.contains('on') ? '1' : '0.4';
});
document.getElementById('btn-schedule-close').addEventListener('click', () => scheduleModal.classList.remove('show'));
document.getElementById('btn-schedule-save').addEventListener('click', () => {
  state.scheduleEnabled = toggleSchedule.classList.contains('on');
  state.scheduleStart = document.getElementById('set-schedule-start').value;
  state.scheduleEnd = document.getElementById('set-schedule-end').value;
  state.scheduleAction = document.getElementById('set-schedule-action').value;
  saveSettings();
  scheduleModal.classList.remove('show');
  updateScheduleUI();
});
scheduleModal.addEventListener('click', e => { if (e.target === scheduleModal) scheduleModal.classList.remove('show'); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PER-SLIDE DURATION MODAL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const durationsModal = document.getElementById('durations-overlay');
const slideDurationList = document.getElementById('slide-duration-list');

document.getElementById('btn-durations').addEventListener('click', () => {
  if (!checkLock('durations')) return;
  slideDurationList.innerHTML = '';
  state.flatSlides.forEach((fs, i) => {
    const slide = state.slides[fs.slideIdx];
    const item = document.createElement('div');
    item.className = 'sdl-item';
    const cur = slide.customDuration ? slide.customDuration / 1000 : '';
    item.innerHTML = `
      <div class="sdl-name">${fs.label}</div>
      <input class="sdl-input" type="number" min="1" max="3600"
             value="${cur}" placeholder="${state.duration/1000}"
             data-sidx="${fs.slideIdx}">
      <span class="sdl-unit">ç§’</span>`;
    slideDurationList.appendChild(item);
  });
  durationsModal.classList.add('show');
});
document.getElementById('btn-durations-close').addEventListener('click', () => durationsModal.classList.remove('show'));
document.getElementById('btn-durations-save').addEventListener('click', () => {
  durationsModal.querySelectorAll('.sdl-input').forEach(inp => {
    const si = parseInt(inp.dataset.sidx);
    const val = parseFloat(inp.value);
    state.slides[si].customDuration = (val > 0) ? val * 1000 : null;
  });
  renderThumbs();
  saveSettings();
  durationsModal.classList.remove('show');
  if (state.playing && !state.paused) scheduleNext();
});
durationsModal.addEventListener('click', e => { if (e.target === durationsModal) durationsModal.classList.remove('show'); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOCK
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const lockSettingsModal = document.getElementById('lock-settings-overlay');
const toggleLock = document.getElementById('toggle-lock');
const lockFields = document.getElementById('lock-fields');

// Open lock settings â€” accessible without lock (meta-feature)
// Add lock settings button inside Settings modal actions
function checkLock(action) {
  if (!state.lockEnabled || !state.lockPassword) return true;
  if (state.locked) {
    state.pendingAction = action;
    lockScreen.classList.add('show');
    lockInput.value = '';
    lockError.style.display = 'none';
    lockInput.focus();
    return false;
  }
  return true;
}

lockInput.addEventListener('keydown', e => { if (e.key === 'Enter') tryUnlock(); });
document.getElementById('btn-lock-enter').addEventListener('click', tryUnlock);

function tryUnlock() {
  if (lockInput.value === state.lockPassword) {
    state.locked = false;
    lockScreen.classList.remove('show');
    lockError.style.display = 'none';
    // re-trigger pending action
    if (state.pendingAction === 'schedule') document.getElementById('btn-schedule').click();
    else if (state.pendingAction === 'durations') document.getElementById('btn-durations').click();
    else if (state.pendingAction === 'settings') document.getElementById('btn-settings').click();
    else if (state.pendingAction === 'clear') btnClear.click();
    state.pendingAction = null;
  } else {
    lockError.style.display = 'block';
    lockInput.value = '';
    lockInput.focus();
  }
}

// Lock settings via topbar settings (added below)
document.getElementById('btn-lock-settings-close').addEventListener('click', () => lockSettingsModal.classList.remove('show'));
document.getElementById('btn-lock-settings-save').addEventListener('click', () => {
  const on = toggleLock.classList.contains('on');
  if (on) {
    const pw = document.getElementById('set-lock-password').value;
    const cf = document.getElementById('set-lock-confirm').value;
    if (pw !== cf || !pw) {
      document.getElementById('lock-setup-error').style.display = 'block';
      return;
    }
    state.lockEnabled = true;
    state.lockPassword = pw;
    state.locked = true;
  } else {
    state.lockEnabled = false;
    state.lockPassword = '';
    state.locked = false;
  }
  saveSettings();
  lockSettingsModal.classList.remove('show');
});
toggleLock.addEventListener('click', () => {
  toggleLock.classList.toggle('on');
  lockFields.style.opacity = toggleLock.classList.contains('on') ? '1' : '0.4';
});
lockSettingsModal.addEventListener('click', e => { if (e.target === lockSettingsModal) lockSettingsModal.classList.remove('show'); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS MODAL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const settingsModal = document.getElementById('settings-overlay');
const toggleLoop = document.getElementById('toggle-loop');
const togglePortrait = document.getElementById('toggle-portrait');
const toggleThumbs = document.getElementById('toggle-thumbs');

document.getElementById('btn-settings').addEventListener('click', () => {
  if (!checkLock('settings')) return;
  document.getElementById('set-duration').value = state.duration / 1000;
  document.getElementById('set-transition').value = state.transition;
  document.getElementById('transition-display').textContent = state.transition + 'ms';
  toggleLoop.classList.toggle('on', state.loop);
  togglePortrait.classList.toggle('on', state.portraitMode);
  toggleThumbs.classList.toggle('on', state.showThumbs);
  settingsModal.classList.add('show');
});
document.getElementById('btn-settings-close').addEventListener('click', () => settingsModal.classList.remove('show'));
document.getElementById('btn-settings-save').addEventListener('click', () => {
  state.duration = Math.max(1000, (parseFloat(document.getElementById('set-duration').value) || 5) * 1000);
  state.transition = parseInt(document.getElementById('set-transition').value) || 350;
  state.loop = toggleLoop.classList.contains('on');
  state.portraitMode = togglePortrait.classList.contains('on');
  state.showThumbs = toggleThumbs.classList.contains('on');
  applyPortraitMode(); applyCanvasTransition();
  saveSettings();
  settingsModal.classList.remove('show');
  updateUI();
  if (state.playing && !state.paused) scheduleNext();
});
document.getElementById('set-transition').addEventListener('input', e => {
  document.getElementById('transition-display').textContent = e.target.value + 'ms';
});
[toggleLoop, togglePortrait, toggleThumbs].forEach(t => t.addEventListener('click', () => t.classList.toggle('on')));
settingsModal.addEventListener('click', e => { if (e.target === settingsModal) settingsModal.classList.remove('show'); });

// Lock settings button â€” append to settings modal actions
(function() {
  const actions = document.querySelector('#settings-overlay .modal-actions');
  const btn = document.createElement('button');
  btn.className = 'ctrl-btn';
  btn.textContent = 'ğŸ”’ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰';
  btn.style.marginRight = 'auto';
  btn.addEventListener('click', () => {
    settingsModal.classList.remove('show');
    toggleLock.classList.toggle('on', state.lockEnabled);
    lockFields.style.opacity = state.lockEnabled ? '1' : '0.4';
    document.getElementById('set-lock-password').value = '';
    document.getElementById('set-lock-confirm').value = '';
    document.getElementById('lock-setup-error').style.display = 'none';
    lockSettingsModal.classList.add('show');
  });
  actions.prepend(btn);
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILE UPLOAD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
fileInput.addEventListener('change', e => {
  exitDemoMode();
  handleFiles(e.target.files);
});
btnAdd.addEventListener('click', () => fileInput.click());

const uploadInner = document.getElementById('upload-inner');
uploadInner.addEventListener('dragover', e => { e.preventDefault(); uploadInner.classList.add('drag-over'); });
uploadInner.addEventListener('dragleave', () => uploadInner.classList.remove('drag-over'));
uploadInner.addEventListener('drop', e => {
  e.preventDefault(); uploadInner.classList.remove('drag-over');
  exitDemoMode(); handleFiles(e.dataTransfer.files);
});

async function handleFiles(files) {
  const pdfs = Array.from(files).filter(f => f.name.toLowerCase().endsWith('.pdf'));
  if (!pdfs.length) return;
  uploadZone.classList.add('hidden');
  loadingText.textContent = 'PDFã‚’èª­ã¿è¾¼ã¿ä¸­â€¦';
  loadingOverlay.classList.add('show');
  await new Promise(r => setTimeout(r, 40));

  for (let fi = 0; fi < pdfs.length; fi++) {
    const file = pdfs[fi];
    loadingText.textContent = `èª­ã¿è¾¼ã¿ä¸­ ${fi+1}/${pdfs.length}: ${file.name}`;
    const ab = await file.arrayBuffer();
    const pdfDoc = await pdfjsLib.getDocument({ data: ab, ...PDFJS_OPTS }).promise;
    const pages = [];
    for (let p = 1; p <= pdfDoc.numPages; p++) {
      const page = await pdfDoc.getPage(p);
      const vp = page.getViewport({ scale: 2 });
      const off = document.createElement('canvas');
      off.width = vp.width; off.height = vp.height;
      await page.render({ canvasContext: off.getContext('2d'), viewport: vp }).promise;
      pages.push({ canvas: off, width: vp.width, height: vp.height });
    }
    state.slides.push({ name: file.name.replace(/\.pdf$/i, ''), pages, customDuration: null });
  }

  loadingOverlay.classList.remove('show');
  rebuildFlatSlides();
  renderThumbs();
  updateUI();
  if (state.flatSlides.length && !state.playing) {
    showSlide(0);
    if (isInSchedule()) startPlayback();
  }
  fileInput.value = '';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FLAT SLIDES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rebuildFlatSlides() {
  state.flatSlides = [];
  state.slides.forEach((slide, si) => {
    slide.pages.forEach((_, pi) => {
      state.flatSlides.push({
        slideIdx: si, pageIdx: pi,
        label: slide.pages.length > 1 ? `${slide.name} ${pi+1}/${slide.pages.length}` : slide.name,
        shortLabel: slide.pages.length > 1 ? `${si+1}-${pi+1}` : `${si+1}`,
      });
    });
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THUMBNAILS + DRAG REORDER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let dragSrcIdx = null;

function renderThumbs() {
  thumbStrip.innerHTML = '';

  state.flatSlides.forEach((fs, i) => {
    const page = state.slides[fs.slideIdx].pages[fs.pageIdx];
    const slide = state.slides[fs.slideIdx];
    const isMultiPage = slide.pages.length > 1;

    const item = document.createElement('div');
    item.className = 'thumb-item';
    item.dataset.index = i;
    item.draggable = true;

    const wrap = document.createElement('div');
    wrap.className = 'thumb-canvas-wrap';
    const tc = document.createElement('canvas');
    // Render at a reasonable resolution; CSS will scale to fit
    const RENDER_W = 240;
    const scale = RENDER_W / page.width;
    tc.width = RENDER_W;
    tc.height = Math.round(page.height * scale);
    tc.getContext('2d').drawImage(page.canvas, 0, 0, tc.width, tc.height);

    const dot = document.createElement('div'); dot.className = 'thumb-dot';

    // Per-slide duration badge
    if (slide.customDuration) {
      const badge = document.createElement('div');
      badge.className = 'thumb-duration';
      badge.textContent = (slide.customDuration / 1000) + 's';
      wrap.appendChild(badge);
    }

    // Delete button (single page)
    const delBtn = document.createElement('div');
    delBtn.className = 'thumb-delete';
    delBtn.textContent = 'Ã—';
    delBtn.title = isMultiPage ? 'ã“ã®ãƒšãƒ¼ã‚¸ã‚’å‰Šé™¤' : 'ã“ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å‰Šé™¤';
    delBtn.addEventListener('click', e => {
      e.stopPropagation();
      deletePage(i);
    });
    wrap.appendChild(delBtn);

    wrap.appendChild(tc); wrap.appendChild(dot);
    const label = document.createElement('div');
    label.className = 'thumb-label'; label.textContent = fs.shortLabel;
    item.appendChild(wrap); item.appendChild(label);

    // Click to jump
    item.addEventListener('click', () => jumpTo(i));

    // Drag reorder
    item.addEventListener('dragstart', e => {
      dragSrcIdx = i;
      item.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    item.addEventListener('dragend', () => {
      item.classList.remove('dragging');
      document.querySelectorAll('.thumb-item').forEach(el => {
        el.classList.remove('drag-over-left', 'drag-over-right');
      });
    });
    item.addEventListener('dragover', e => {
      e.preventDefault();
      const rect = item.getBoundingClientRect();
      const mid = rect.left + rect.width / 2;
      item.classList.toggle('drag-over-left', e.clientX < mid);
      item.classList.toggle('drag-over-right', e.clientX >= mid);
    });
    item.addEventListener('dragleave', () => {
      item.classList.remove('drag-over-left', 'drag-over-right');
    });
    item.addEventListener('drop', e => {
      e.preventDefault();
      if (dragSrcIdx === null || dragSrcIdx === i) return;
      const rect = item.getBoundingClientRect();
      const insertBefore = e.clientX < rect.left + rect.width / 2;
      const moved = state.flatSlides.splice(dragSrcIdx, 1)[0];
      let insertIdx = i > dragSrcIdx ? i - 1 : i;
      if (!insertBefore) insertIdx++;
      state.flatSlides.splice(insertIdx, 0, moved);
      rebuildSlidesFromFlat();
      rebuildFlatSlides();
      renderThumbs();
      state.current = Math.min(state.current, state.flatSlides.length - 1);
      showSlide(state.current);
      dragSrcIdx = null;
    });

    thumbStrip.appendChild(item);
  });
  updateActiveThumb();
}

function rebuildSlidesFromFlat() {
  // Re-order slides array based on the new flatSlides order
  const newSlides = [];
  const seen = new Set();
  state.flatSlides.forEach(fs => {
    if (!seen.has(fs.slideIdx)) {
      seen.add(fs.slideIdx);
      newSlides.push(state.slides[fs.slideIdx]);
    }
  });
  state.slides = newSlides;
}

// Delete a single page by its flatSlides index
function deletePage(flatIdx) {
  if (!state.flatSlides.length) return;
  const fs = state.flatSlides[flatIdx];
  const slide = state.slides[fs.slideIdx];

  if (slide.pages.length === 1) {
    // Only page in this file â†’ delete the whole file
    deleteFile(fs.slideIdx);
    return;
  }

  // Remove just this page from the slide
  slide.pages.splice(fs.pageIdx, 1);
  rebuildFlatSlides();
  _afterDelete();
}

// Delete all pages of a file by its slideIdx
function deleteFile(slideIdx) {
  if (!state.slides.length) return;
  state.slides.splice(slideIdx, 1);
  rebuildFlatSlides();
  _afterDelete();
}

function _afterDelete() {
  if (state.flatSlides.length === 0) {
    stopPlayback();
    thumbStrip.innerHTML = '';
    mainCanvas.style.display = 'none';
    mainCanvas.style.opacity = '1';
    emptyState.style.display = 'flex';
    slideInfo.textContent = '';
    updateUI();
    uploadZone.classList.remove('hidden');
    return;
  }
  state.current = Math.min(state.current, state.flatSlides.length - 1);
  renderThumbs();
  updateUI();
  showSlide(state.current);
  if (state.playing && !state.paused) scheduleNext();
}

function updateActiveThumb() {
  document.querySelectorAll('.thumb-item').forEach((el, i) => {
    el.classList.toggle('active', i === state.current);
  });
  const active = thumbStrip.children[state.current];
  if (active) active.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI STATE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateUI() {
  const count = state.flatSlides.length;
  slideCountLabel.textContent = count ? `${count} ã‚¹ãƒ©ã‚¤ãƒ‰` : 'â€”';
  thumbStripCount.textContent = `${count} æš`;
  btnPlay.disabled = count === 0;
  document.getElementById('btn-durations').disabled = count === 0;
  btnClear.style.display = count ? 'inline-block' : 'none';
  const showStrip = count && state.showThumbs;
  thumbStripWrap.style.display = showStrip ? 'block' : 'none';
  document.body.classList.toggle('thumbs-visible', !!showStrip);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHOW SLIDE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showSlide(index) {
  if (!state.flatSlides.length) return;
  state.current = ((index % state.flatSlides.length) + state.flatSlides.length) % state.flatSlides.length;
  const fs = state.flatSlides[state.current];
  const page = state.slides[fs.slideIdx].pages[fs.pageIdx];

  mainCanvas.style.opacity = '0';
  setTimeout(() => {
    mainCanvas.width = page.width;
    mainCanvas.height = page.height;
    ctx.drawImage(page.canvas, 0, 0);
    mainCanvas.style.opacity = '1';
    mainCanvas.style.display = 'block';
  }, state.transition / 2);

  emptyState.style.display = 'none';
  slideInfo.textContent = `${state.current + 1} / ${state.flatSlides.length}`;
  updateActiveThumb();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PLAYBACK
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getCurrentDuration() {
  if (!state.flatSlides.length) return state.duration;
  const fs = state.flatSlides[state.current];
  return state.slides[fs.slideIdx].customDuration || state.duration;
}

function startPlayback() {
  if (!state.flatSlides.length) return;
  state.playing = true; state.paused = false;
  btnPlay.textContent = 'â¸ ä¸€æ™‚åœæ­¢'; btnPlay.classList.add('active');
  scheduleNext();
}

function scheduleNext() {
  clearTimeout(state.timer);
  if (state.paused || !state.playing) return;
  const dur = getCurrentDuration();
  progressBar.style.transition = 'none'; progressBar.style.width = '0%';
  requestAnimationFrame(() => requestAnimationFrame(() => {
    progressBar.style.transition = `width ${dur}ms linear`;
    progressBar.style.width = '100%';
  }));
  state.timer = setTimeout(() => {
    const next = state.current + 1;
    if (next >= state.flatSlides.length) {
      if (state.loop) { showSlide(0); scheduleNext(); }
      else stopPlayback();
    } else {
      showSlide(next); scheduleNext();
    }
  }, dur);
}

function stopPlayback() {
  state.playing = false; state.paused = false;
  clearTimeout(state.timer);
  progressBar.style.transition = 'none'; progressBar.style.width = '0%';
  btnPlay.textContent = 'â–¶ å†ç”Ÿ'; btnPlay.classList.remove('active');
  pauseOverlay.classList.remove('show');
}

function jumpTo(index) {
  showSlide(index);
  if (state.playing && !state.paused) scheduleNext();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PLAY BUTTON
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
btnPlay.addEventListener('click', () => {
  if (!state.flatSlides.length) return;
  if (!state.playing) {
    startPlayback();
  } else if (!state.paused) {
    state.paused = true; clearTimeout(state.timer);
    progressBar.style.transition = 'none';
    pauseOverlay.classList.add('show');
    btnPlay.textContent = 'â–¶ å†ç”Ÿ'; btnPlay.classList.remove('active');
  } else {
    state.paused = false;
    pauseOverlay.classList.remove('show');
    btnPlay.textContent = 'â¸ ä¸€æ™‚åœæ­¢'; btnPlay.classList.add('active');
    scheduleNext();
  }
});
mainCanvas.addEventListener('click', () => { if (state.flatSlides.length) btnPlay.click(); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLEAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
btnClear.addEventListener('click', () => {
  if (!checkLock('clear')) return;
  if (!confirm('ã™ã¹ã¦ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  stopPlayback();
  state.slides = []; state.flatSlides = [];
  thumbStrip.innerHTML = '';
  mainCanvas.style.display = 'none'; mainCanvas.style.opacity = '1';
  emptyState.style.display = 'flex';
  slideInfo.textContent = '';
  exitDemoMode();
  updateUI();
  uploadZone.classList.remove('hidden');
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KEYBOARD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown', e => {
  const anyModal = document.querySelector('.modal-overlay.show, #lock-screen.show');
  if (anyModal) return;
  if (e.key === ' ') { e.preventDefault(); if (state.flatSlides.length) btnPlay.click(); }
  if (e.key === 'ArrowRight' && state.flatSlides.length) jumpTo(state.current + 1);
  if (e.key === 'ArrowLeft' && state.flatSlides.length) jumpTo(state.current - 1);
  if (e.key === 'f' || e.key === 'F') btnFullscreen.click();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CANVAS TRANSITION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function applyCanvasTransition() {
  mainCanvas.style.transition = `opacity ${state.transition}ms ease`;
}
applyCanvasTransition();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DEMO MODE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DEMO_SLIDES = [
  { title:'Digital Signage v2', subtitle:'Professional Display System', tag:'Welcome',
    body:'PDFå½¢å¼ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç¾ã—ãã€åŠ¹ç‡çš„ã«è¡¨ç¤ºã€‚\nã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ­ãƒƒã‚¯ãƒ»ç¸¦ç”»é¢ã«å¯¾å¿œã€‚',
    accent:'#4f8ef7', bg:['#0a0c10','#111420'] },
  { title:'Company Overview', subtitle:'About Our Organization', tag:'About',
    body:'è¨­ç«‹ä»¥æ¥ã€ãƒ‡ã‚¸ã‚¿ãƒ«ã‚µã‚¤ãƒãƒ¼ã‚¸ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã®\nãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚«ãƒ³ãƒ‘ãƒ‹ãƒ¼ã¨ã—ã¦å¤šæ§˜ãªãŠå®¢æ§˜ã‚’æ”¯æ´ã€‚',
    accent:'#7eb8f5', bg:['#0c1018','#0e1520'] },
  { title:'Key Features', subtitle:'What Makes Us Different', tag:'Features',
    body:'â€¢ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è‡ªå‹•é…ä¿¡\nâ€¢ ã‚¹ãƒ©ã‚¤ãƒ‰ã”ã¨ã®è¡¨ç¤ºæ™‚é–“è¨­å®š\nâ€¢ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ä¸¦ã³æ›¿ãˆ\nâ€¢ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ­ãƒƒã‚¯',
    accent:'#5dd8b0', bg:['#091210','#0e1a18'] },
  { title:'Performance', subtitle:'Results & Metrics', tag:'Data',
    body:'ç¨¼åƒç‡  99.9%\nè¡¨ç¤ºãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ  60fps\nå¯¾å¿œãƒ•ã‚¡ã‚¤ãƒ«æ•°  ç„¡åˆ¶é™\nãƒšãƒ¼ã‚¸æ•°  ç„¡åˆ¶é™',
    accent:'#f0a855', bg:['#110e08','#1a1508'] },
  { title:'3 Themes Available', subtitle:'Dark Â· Light Â· Warm', tag:'Design',
    body:'å³ä¸Šã®ã‚«ãƒ©ãƒ¼ãƒ‰ãƒƒãƒˆã‹ã‚‰ãƒ†ãƒ¼ãƒã‚’åˆ‡æ›¿ã€‚\nã‚ªãƒ•ã‚£ã‚¹ãƒ»åº—èˆ—ãƒ»ãƒ›ãƒ†ãƒ«ãªã©ã‚·ãƒ¼ãƒ³ã«åˆã‚ã›ã¦\nãƒ‡ã‚¶ã‚¤ãƒ³ã‚’é¸æŠã§ãã¾ã™ã€‚',
    accent:'#c47ef5', bg:['#0e0b14','#150e1e'] },
];

function generateDemoCanvas(data) {
  const W = 1280, H = 720;
  const c = document.createElement('canvas'); c.width = W; c.height = H;
  const cx = c.getContext('2d');
  const g = cx.createLinearGradient(0,0,W,H);
  g.addColorStop(0, data.bg[0]); g.addColorStop(1, data.bg[1]);
  cx.fillStyle = g; cx.fillRect(0,0,W,H);
  // Grid
  cx.strokeStyle = 'rgba(255,255,255,0.022)'; cx.lineWidth = 1;
  for (let x=0;x<W;x+=60){cx.beginPath();cx.moveTo(x,0);cx.lineTo(x,H);cx.stroke();}
  for (let y=0;y<H;y+=60){cx.beginPath();cx.moveTo(0,y);cx.lineTo(W,y);cx.stroke();}
  // Glow
  const rg = cx.createRadialGradient(W*.78,H*.28,0,W*.78,H*.28,W*.42);
  rg.addColorStop(0, data.accent+'28'); rg.addColorStop(1,'transparent');
  cx.fillStyle = rg; cx.fillRect(0,0,W,H);
  // Accent bar
  cx.fillStyle = data.accent; cx.fillRect(60,158,4,210);
  // Tag
  cx.fillStyle = data.accent+'20'; cx.strokeStyle = data.accent+'50'; cx.lineWidth=1;
  roundRect(cx,68,150,94,26,4); cx.fill(); cx.stroke();
  cx.fillStyle = data.accent; cx.font = '500 11px DM Sans,sans-serif';
  cx.fillText(data.tag.toUpperCase(),80,167);
  // Title
  cx.fillStyle = '#e8ecf4'; cx.font = '300 62px DM Sans,sans-serif';
  cx.fillText(data.title,72,262);
  // Subtitle
  cx.fillStyle = data.accent+'bb'; cx.font = '300 21px DM Sans,sans-serif';
  cx.fillText(data.subtitle,72,305);
  // Divider
  cx.strokeStyle='rgba(255,255,255,0.06)'; cx.lineWidth=1;
  cx.beginPath(); cx.moveTo(72,328); cx.lineTo(W-72,328); cx.stroke();
  // Body
  cx.fillStyle='rgba(232,236,244,0.5)'; cx.font='300 17px Noto Sans JP,DM Sans,sans-serif';
  data.body.split('\n').forEach((l,i)=>cx.fillText(l,72,370+i*38));
  // Footer
  cx.fillStyle='rgba(255,255,255,0.03)'; cx.fillRect(0,H-50,W,50);
  cx.strokeStyle='rgba(255,255,255,0.04)'; cx.beginPath(); cx.moveTo(0,H-50); cx.lineTo(W,H-50); cx.stroke();
  cx.fillStyle='rgba(255,255,255,0.18)'; cx.font='300 11px DM Sans,sans-serif';
  cx.fillText('PDF Digital Signage v2  Â·  Demo Mode',72,H-18);
  const dt = new Date().toLocaleDateString('ja-JP',{year:'numeric',month:'long',day:'numeric'});
  cx.fillStyle=data.accent+'80'; const dw=cx.measureText(dt).width;
  cx.fillText(dt,W-72-dw,H-18);
  return c;
}
function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath(); ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+r); ctx.lineTo(x+w,y+h-r);
  ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h); ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r); ctx.lineTo(x,y+r);
  ctx.quadraticCurveTo(x,y,x+r,y); ctx.closePath();
}

async function startDemoMode() {
  if (state.isDemo) { exitDemoMode(); return; }
  stopPlayback();
  state.slides = []; state.flatSlides = [];
  thumbStrip.innerHTML = ''; mainCanvas.style.display = 'none';
  emptyState.style.display = 'flex'; slideInfo.textContent = '';
  updateUI();
  loadingText.textContent = 'ãƒ‡ãƒ¢ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆä¸­â€¦';
  loadingOverlay.classList.add('show');
  await new Promise(r=>setTimeout(r,50));
  for (let i=0;i<DEMO_SLIDES.length;i++) {
    loadingText.textContent = `ãƒ‡ãƒ¢ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆä¸­â€¦ (${i+1}/${DEMO_SLIDES.length})`;
    await new Promise(r=>setTimeout(r,16));
    const c = generateDemoCanvas(DEMO_SLIDES[i]);
    state.slides.push({ name:DEMO_SLIDES[i].title, pages:[{canvas:c,width:c.width,height:c.height}], customDuration:null });
  }
  loadingOverlay.classList.remove('show');
  uploadZone.classList.add('hidden');
  state.isDemo = true;
  rebuildFlatSlides(); renderThumbs(); updateUI();
  demoBadge.classList.add('show');
  btnDemo.classList.add('active'); btnDemo.textContent = 'ãƒ‡ãƒ¢çµ‚äº†';
  showSlide(0);
  if (isInSchedule()) startPlayback();
}

function exitDemoMode() {
  state.isDemo = false;
  demoBadge.classList.remove('show');
  btnDemo.classList.remove('active'); btnDemo.textContent = 'ãƒ‡ãƒ¢';
}

btnDemo.addEventListener('click', startDemoMode);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOUCH DRAG & DROP
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function() {
  let touchSrcIdx = null;
  let ghost = null;
  let lastOverIdx = null;

  function getThumbItems() {
    return Array.from(thumbStrip.querySelectorAll('.thumb-item'));
  }

  function createGhost(item, touch) {
    const rect = item.getBoundingClientRect();
    ghost = item.cloneNode(true);
    ghost.style.cssText = `
      position: fixed;
      width: ${rect.width}px;
      opacity: 0.75;
      pointer-events: none;
      z-index: 9999;
      transform: scale(1.05);
      transition: none;
      border-radius: 6px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      left: ${rect.left}px;
      top: ${rect.top}px;
    `;
    document.body.appendChild(ghost);
    return { offsetX: touch.clientX - rect.left, offsetY: touch.clientY - rect.top };
  }

  function moveGhost(touch, offsetX, offsetY) {
    if (!ghost) return;
    ghost.style.left = (touch.clientX - offsetX) + 'px';
    ghost.style.top  = (touch.clientY - offsetY) + 'px';
  }

  function getIdxFromTouch(touch) {
    const items = getThumbItems();
    for (let i = 0; i < items.length; i++) {
      const rect = items[i].getBoundingClientRect();
      if (touch.clientX >= rect.left && touch.clientX <= rect.right &&
          touch.clientY >= rect.top  && touch.clientY <= rect.bottom) {
        return i;
      }
    }
    return null;
  }

  function clearOverHighlight() {
    getThumbItems().forEach(el => el.classList.remove('drag-over-left', 'drag-over-right'));
  }

  thumbStrip.addEventListener('touchstart', e => {
    const item = e.target.closest('.thumb-item');
    if (!item) return;
    if (e.target.closest('.thumb-delete')) return;
    touchSrcIdx = parseInt(item.dataset.index);
    const touch = e.touches[0];
    const { offsetX, offsetY } = createGhost(item, touch);
    item.classList.add('dragging');

    function onTouchMove(e) {
      e.preventDefault();
      const t = e.touches[0];
      moveGhost(t, offsetX, offsetY);
      const overIdx = getIdxFromTouch(t);
      if (overIdx !== null && overIdx !== lastOverIdx) {
        clearOverHighlight();
        lastOverIdx = overIdx;
        const items = getThumbItems();
        const overItem = items[overIdx];
        const rect = overItem.getBoundingClientRect();
        overItem.classList.toggle('drag-over-left', t.clientX < rect.left + rect.width / 2);
        overItem.classList.toggle('drag-over-right', t.clientX >= rect.left + rect.width / 2);
      }
    }

    function onTouchEnd(e) {
      thumbStrip.removeEventListener('touchmove', onTouchMove);
      thumbStrip.removeEventListener('touchend', onTouchEnd);
      document.removeEventListener('touchend', onTouchEnd);

      if (ghost) { ghost.remove(); ghost = null; }
      item.classList.remove('dragging');
      clearOverHighlight();

      const t = e.changedTouches[0];
      const overIdx = getIdxFromTouch(t);

      if (overIdx !== null && overIdx !== touchSrcIdx) {
        const items = getThumbItems();
        const overItem = items[overIdx];
        const rect = overItem.getBoundingClientRect();
        const insertBefore = t.clientX < rect.left + rect.width / 2;
        const moved = state.flatSlides.splice(touchSrcIdx, 1)[0];
        let insertIdx = overIdx > touchSrcIdx ? overIdx - 1 : overIdx;
        if (!insertBefore) insertIdx++;
        state.flatSlides.splice(insertIdx, 0, moved);
        rebuildSlidesFromFlat();
        rebuildFlatSlides();
        renderThumbs();
        state.current = Math.min(state.current, state.flatSlides.length - 1);
        showSlide(state.current);
      }

      touchSrcIdx = null;
      lastOverIdx = null;
    }

    thumbStrip.addEventListener('touchmove', onTouchMove, { passive: false });
    thumbStrip.addEventListener('touchend', onTouchEnd);
    document.addEventListener('touchend', onTouchEnd);
  }, { passive: true });
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
loadSettings();
startScheduleChecker();
updateUI();
</script>
</body>
</html>
